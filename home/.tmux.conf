# =============================================================================
# Environment
# =============================================================================

# Ensure local bin is available for run-shell/external plugins
set-environment -g PATH "$HOME/.tmux/bin:$HOME/.local/bin:/opt/homebrew/bin:$PATH"

# =============================================================================
# Plugins (TPM + PowerKit)
# =============================================================================

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'babarot/tmux-powerkit#feature/separate-left-right-plugins'
set -g @plugin 'joshmedeski/t-smart-tmux-session-manager'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# PowerKit theme (Tokyo Night)
set -g @powerkit_theme 'tokyo-night'
set -g @powerkit_theme_variant 'storm'
set -g @powerkit_theme_selector_key "F"
set -g @powerkit_plugin_datetime_format "%Y/%m/%d %H:%M"
set -g @powerkit_plugin_datetime_icon "DATE"
# t-smart keybinding (override tmux default find-window on prefix+f)
set -g @t-bind "f"
# resurrect/continuum
set -g @resurrect-save 'S'
set -g @resurrect-restore 'R'
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'
# Show full window names on status bar (no truncation).
set -g @powerkit_active_window_title '#{window_name}'
set -g @powerkit_inactive_window_title '#{window_name}'

# PowerKit plugins (use external commands)
set -g @powerkit_plugins_left 'external(|$(~/.tmux/bin/kube)|secondary|accent|0)'
set -g @powerkit_plugins_right 'network,vpn,cpu,memory,external(|$(tmux-ime-status)|secondary|accent|0),battery,external(|$(~/.tmux/bin/wifi-status)|secondary|accent|0),datetime'

# =============================================================================
# Basics
# =============================================================================

set -g prefix None
bind-key -N "Enter prefix mode (force EN IME)" -T root C-s run-shell "macism com.apple.keylayout.ABC >/dev/null 2>&1" \; switch-client -T prefix
bind-key -N "Send Ctrl-s to pane" -T prefix C-s send-keys C-s
set-environment -g EDITOR vim
set-environment -g VISUAL vim

bind-key -N "Focus pane left" h select-pane -L
bind-key -N "Focus pane down" j select-pane -D
bind-key -N "Focus pane up" k select-pane -U
bind-key -N "Focus pane right" l select-pane -R
bind-key -N "Resize pane left" -r H resize-pane -L 5
bind-key -N "Resize pane down" -r J resize-pane -D 5
bind-key -N "Resize pane up" -r K resize-pane -U 5
bind-key -N "Resize pane right" -r L resize-pane -R 5
bind-key -N "Kill current pane (no confirm)" q kill-pane
bind-key -N "Show pane numbers" Q display-panes
bind-key -N "Next client" N switch-client -n
bind-key -N "Previous client" P switch-client -p
unbind %
unbind '"'
bind-key -N "Split horizontally in current path" | split-window -h -c "#{pane_current_path}"
bind-key -N "Split horizontally in current path" % split-window -h -c "#{pane_current_path}"
bind-key -N "Split vertically in current path" - split-window -c "#{pane_current_path}"
bind-key -N "Split vertically in current path" '"' split-window -v -c "#{pane_current_path}"
set-window-option -g mode-keys vi
set -s escape-time 0
set -g mouse on
bind-key -N "Reload tmux config" r source-file ~/.tmux.conf \; display-message "tmux.conf reloaded"
bind-key -N "Reload tmux config" C-r source-file ~/.tmux.conf \; display-message "tmux.conf reloaded"
bind-key -N "Split and run dot apply" a split-window -v -c "#{pane_current_path}" "dot apply; exec $SHELL"
bind-key -N "Show tmux cheatsheet popup" / display-popup -E "~/.tmux/bin/tmux-cheatsheet-viewer"

# Copy to system clipboard (macOS)
set -g set-clipboard on
bind-key -N "Copy selection to macOS clipboard" -T copy-mode-vi y send -X copy-pipe-and-cancel "pbcopy"
bind-key -N "Copy selection to macOS clipboard" -T copy-mode-vi Enter send -X copy-pipe-and-cancel "pbcopy"
bind-key -N "Exit copy mode" -T copy-mode-vi Escape send -X cancel
bind-key -N "Copy selection to macOS clipboard" -T copy-mode y send -X copy-pipe-and-cancel "pbcopy"
bind-key -N "Copy selection to macOS clipboard" -T copy-mode Enter send -X copy-pipe-and-cancel "pbcopy"
bind-key -N "Exit copy mode" -T copy-mode Escape send -X cancel

# Status bar
set -g status-interval 5
set -g status-position top
set -g status-left-length 80
set -g status-right-length 120
set -g focus-events on
set -g allow-rename off
set -g automatic-rename off
set -g visual-activity on
bind-key -N "Toggle 60s silence monitor" M if -F '#{==:#{monitor-silence},0}' \
  'setw monitor-activity on \; setw monitor-silence 60 \; display-message "silence monitor: ON (60s)"' \
  'setw monitor-silence 0 \; display-message "silence monitor: OFF"'

# Pane border status (show active pane context)
set -g pane-border-status top
set -g pane-border-format "#P: #{pane_current_command} â€” #{pane_current_path}"

# TPM bootstrap
run '~/.tmux/plugins/tpm/tpm'

# Re-assert custom key bindings after plugin load
unbind -T prefix w
bind-key -N "Choose window (shows activity flag)" -T prefix w choose-tree -Zw -F '#{window_name} #{?window_activity_flag,*,}'
unbind -T prefix \;
bind-key -N "Switch to last session" -T prefix \; switch-client -l
bind-key -N "Move current window left" -T prefix < swap-window -t :-1
bind-key -N "Move current window right" -T prefix > swap-window -t :+1
unbind -T prefix ?
bind-key -N "Show keybinding help (all prefix keys)" -T prefix ? list-keys -T prefix
unbind -T prefix g
bind-key -N "Open window action menu" -T prefix g display-menu -T "#[align=centre]#{window_index}:#{window_name}" -x W -y W \
  "#{?#{>:#{session_windows},1},,-}Swap Left" l { swap-window -t :-1 } \
  "#{?#{>:#{session_windows},1},,-}Swap Right" r { swap-window -t :+1 } \
  "#{?pane_marked_set,,-}Swap Marked" s { swap-window } \
  '' Kill X { kill-window } Respawn R { respawn-window -k } \
  "#{?pane_marked,Unmark,Mark}" m { select-pane -m } \
  Rename n { command-prompt -F -I "#W" { rename-window -t "#{window_id}" "%%" } } \
  '' "New After" w { new-window -a } "New At End" W { new-window }
