#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF'
Usage:
  ev s <query>         # Shared (dotfiles across devices)
  ev m <query>         # Machine (this device, shared across dirs)
  ev d <query>         # Dir (current directory only)
  ev apply s|m|d       # Apply changes for each scope
  ev s apply           # Apply shared
  ev m apply           # Apply machine
  ev d apply           # Apply dir

Scopes:
  s = shared  (dotfiles across devices)
  m = machine (this device)
  d = dir     (current directory)
EOF
}

die() { echo "ev: $*" >&2; exit 1; }

has_cmd() { command -v "$1" >/dev/null 2>&1; }

DOTFILES_DIR="${EV_DOTFILES_DIR:-${DOTFILES_DIR:-$HOME/src/github/k4h4shi/dotfiles}}"
HOME_NIX="$DOTFILES_DIR/modules/home.nix"
DARWIN_NIX="$DOTFILES_DIR/modules/darwin.nix"

LOCAL_ENV_DIR="$HOME/.config/local-env"
LOCAL_FLAKE="$LOCAL_ENV_DIR/flake.nix"

ensure_local_env() {
  if [ ! -d "$LOCAL_ENV_DIR" ]; then
    mkdir -p "$LOCAL_ENV_DIR"
  fi
  if [ ! -e "$LOCAL_FLAKE" ] && [ -f "$LOCAL_ENV_DIR/flake.nix.template" ]; then
    cp "$LOCAL_ENV_DIR/flake.nix.template" "$LOCAL_FLAKE"
  fi
  if [ ! -e "$LOCAL_ENV_DIR/.envrc" ]; then
    printf '%s\n' "use flake" > "$LOCAL_ENV_DIR/.envrc"
  fi
}

project_flake_template() {
  cat <<'EOF'
{
  description = "Project-local environment";

  inputs = {
    nixpkgs.url = "github:nixos/nixpkgs/nixpkgs-unstable";
  };

  outputs = { nixpkgs, ... }:
    let
      systems = [ "aarch64-darwin" "x86_64-darwin" "x86_64-linux" "aarch64-linux" ];
      forAllSystems = nixpkgs.lib.genAttrs systems;
    in
    {
      devShells = forAllSystems (system:
        let
          pkgs = nixpkgs.legacyPackages.${system};
        in
        {
          default = pkgs.mkShell {
            packages = with pkgs; [
              # ev:packages:start
              # Add project-local packages here
              # ev:packages:end
            ];
          };
        }
      );
    };
}
EOF
}

ensure_project_env() {
  if [ ! -f "./flake.nix" ]; then
    project_flake_template > "./flake.nix"
  fi
  if [ ! -f "./.envrc" ]; then
    printf '%s\n' "use flake" > "./.envrc"
  fi
}

add_to_marked_list() {
  local file="$1"
  local start="$2"
  local end="$3"
  local line="$4"

  rg -q --fixed-strings "$line" "$file" && return 0

  awk -v start="$start" -v end="$end" -v line="$line" '
    { print }
    $0 ~ end && !added {
      print line
      added = 1
    }
  ' "$file" > "${file}.ev.tmp"
  mv "${file}.ev.tmp" "$file"
}

search_nix() {
  local query="$1"
  nix search nixpkgs "$query" --json 2>/dev/null \
    | jq -r 'to_entries[] | "nix\t" + .key + "\t" + (.value.version // "") + "\t" + (.value.description // "")'
}

search_cask() {
  local query="$1"
  if ! has_cmd brew; then
    return 0
  fi
  brew search --casks "$query" 2>/dev/null \
    | awk '{print "cask\t" $0}'
}

choose_candidate() {
  local query="$1"
  local scope="$2"
  local candidates

  candidates="$(search_nix "$query")"
  if [ "$scope" = "s" ] || [ "$scope" = "m" ]; then
    candidates="${candidates}"$'\n'"$(search_cask "$query")"
  fi

  if [ -z "${candidates//[$'\t\r\n ']}" ]; then
    die "no candidates found for: $query"
  fi

  if has_cmd fzf; then
    printf "%s\n" "$candidates" | fzf --prompt="ev> " --with-nth=2,3,4
  else
    local i=1
    echo "$candidates" | while IFS= read -r line; do
      printf "%2d) %s\n" "$i" "$line"
      i=$((i + 1))
    done
    printf "select> " >&2
    read -r idx
    echo "$candidates" | sed -n "${idx}p"
  fi
}

apply_global() {
  (cd "$DOTFILES_DIR" && ./apply.sh) || die "apply.sh failed"
}

apply_local() {
  local profile="$HOME/.local-env/profile"
  mkdir -p "$HOME/.local-env"
  if ! nix profile list --profile "$profile" >/dev/null 2>&1; then
    nix profile add --profile "$profile" "$LOCAL_ENV_DIR#local-env" || die "profile install failed"
  else
    if nix profile list --profile "$profile" 2>/dev/null | grep -q "local-env"; then
      nix profile remove --profile "$profile" local-env >/dev/null 2>&1 || true
      nix profile add --profile "$profile" "$LOCAL_ENV_DIR#local-env" || die "profile install failed"
    else
      nix profile add --profile "$profile" "$LOCAL_ENV_DIR#local-env" || die "profile install failed"
    fi
  fi

  if command -v direnv >/dev/null 2>&1; then
    (cd "$LOCAL_ENV_DIR" && direnv reload) || true
  fi
}

apply_project() {
  direnv reload || die "direnv reload failed"
}

scope="${1:-}"
if [ -z "$scope" ]; then
  usage
  exit 1
fi

query="${2:-}"
if [ -z "$query" ]; then
  usage
  exit 1
fi

if [ "$scope" = "apply" ]; then
  case "$query" in
    s) apply_global ;;
    m) apply_local ;;
    d) apply_project ;;
    *) usage; exit 1 ;;
  esac
  exit 0
fi

if [ "$query" = "apply" ]; then
  case "$scope" in
    s) apply_global ;;
    m) apply_local ;;
    d) apply_project ;;
    *) usage; exit 1 ;;
  esac
  exit 0
fi

choice="$(choose_candidate "$query" "$scope")"
kind="$(echo "$choice" | awk -F'\t' '{print $1}')"
name="$(echo "$choice" | awk -F'\t' '{print $2}')"

case "$scope" in
  s)
    if [ "$kind" = "nix" ]; then
      add_to_marked_list "$HOME_NIX" "ev:packages:start" "ev:packages:end" "    ${name#nixpkgs#}"
      echo "Added to home.nix: ${name#nixpkgs#}"
      echo "Run: (cd \"$DOTFILES_DIR\" && ./apply.sh)"
    else
      add_to_marked_list "$DARWIN_NIX" "ev:casks:common:start" "ev:casks:common:end" "    \"${name}\""
      echo "Added to darwin.nix casks: ${name}"
      echo "Run: (cd \"$DOTFILES_DIR\" && ./apply.sh)"
    fi
    ;;
  m)
    ensure_local_env
    if [ "$kind" = "nix" ]; then
      add_to_marked_list "$LOCAL_FLAKE" "ev:packages:start" "ev:packages:end" "              ${name#nixpkgs#}"
      echo "Added to local flake: ${name#nixpkgs#}"
      echo "Run: ev m apply"
    else
      brew install --cask "$name"
    fi
    ;;
  d)
    ensure_project_env
    if [ "$kind" = "nix" ]; then
      add_to_marked_list "./flake.nix" "ev:packages:start" "ev:packages:end" "              ${name#nixpkgs#}"
      echo "Added to project flake: ${name#nixpkgs#}"
      echo "Run: direnv allow (first time) / direnv reload"
    else
      die "project scope supports nix packages only"
    fi
    ;;
  *)
    usage
    exit 1
    ;;
esac
