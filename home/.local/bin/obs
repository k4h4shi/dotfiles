#!/usr/bin/env bash
set -euo pipefail

VAULT="${OBS_VAULT:-$HOME/src/github/k4h4shi/k4h4shi.com/vault}"
EDITOR_CMD="${OBS_EDITOR:-vim}"
DAILY_DIR="$VAULT/10_private/02_daily"
PUBLIC_DIR="$VAULT/00_garden/thoughts"
DRAFT_DIR="$VAULT/00_garden/drafts"
TEMPLATE="$VAULT/90_templates/Daily Template.md"
DRAFT_TEMPLATE="$VAULT/90_templates/Post Draft.md"

usage() {
  cat <<'USAGE'
Usage:
  obs daily     # open today's daily note (create if missing)
  obs draft     # create a new draft post
  obs post      # pick a public post via fzf and open
  obs memos     # append a memo to today's daily note
  obs d|p|m     # aliases for daily/post/memos
  obs help
Environment:
  OBS_VAULT   # vault path (default: ~/src/github/k4h4shi/k4h4shi.com/vault)
  OBS_EDITOR  # editor command (default: vim)
  OBS_DRAFT_DIR      # draft posts path (default: $VAULT/00_garden/drafts)
  OBS_DRAFT_TEMPLATE # draft template path (default: $VAULT/90_templates/Post Draft.md)
USAGE
}

die() {
  echo "obs: $*" >&2
  exit 1
}

ensure_cmd() {
  command -v "$1" >/dev/null 2>&1 || die "missing dependency: $1"
}

render_template() {
  local template="$1"
  local title="${2:-}"
  local date_str="${3:-}"
  python3 - "$template" "$title" "$date_str" <<'PY'
import re
import sys
from pathlib import Path

template = Path(sys.argv[1])
title = sys.argv[2]
date_str = sys.argv[3]

in_block = False
out_lines = []

for line in template.read_text(encoding="utf-8").splitlines(True):
    if not in_block and line.lstrip().startswith("<%*"):
        in_block = True
        if "%>" in line:
            in_block = False
        continue
    if in_block:
        if "%>" in line:
            in_block = False
        continue
    if title:
        line = line.replace('<% tp.file.title %>', title)
    if date_str:
        line = line.replace('<% tp.date.now("YYYY-MM-DD") %>', date_str)
    line = re.sub(r"<%.*?%>", "", line)
    out_lines.append(line)

sys.stdout.write("".join(out_lines))
PY
}

render_draft_frontmatter() {
  local title="$1"
  local date_str="$2"
  python3 - "$title" "$date_str" <<'PY'
import sys

title = sys.argv[1]
date_str = sys.argv[2]

sys.stdout.write("---\n")
sys.stdout.write(f'title: "{title}"\n')
sys.stdout.write(f"date: {date_str}\n")
sys.stdout.write("draft: true\n")
sys.stdout.write("---\n\n")
PY
}

slugify() {
  local title="$1"
  python3 - "$title" <<'PY'
import re
import sys

title = sys.argv[1].strip().lower()
title = re.sub(r"[^a-z0-9]+", "-", title)
title = re.sub(r"-{2,}", "-", title).strip("-")
print(title or "untitled")
PY
}

append_memo() {
  local daily_file="$1"
  local text="$2"
  local time_str
  time_str="$(date +%H:%M)"
  python3 - "$daily_file" "$time_str" "$text" <<'PY'
import sys
from pathlib import Path

path = Path(sys.argv[1])
time_str = sys.argv[2]
text = sys.argv[3].strip()

if not text:
    sys.exit(0)

lines = path.read_text(encoding="utf-8").splitlines(True)

if lines and not lines[-1].endswith("\n"):
    lines[-1] += "\n"

lines.append(f"- {time_str} {text}\n")

path.write_text("".join(lines), encoding="utf-8")
PY
}

capture_memo_text() {
  local tmp
  tmp="$(mktemp "${TMPDIR:-/tmp}/obs-memo.XXXXXX")"
  "$EDITOR_CMD" "$tmp"
  if [[ -s "$tmp" ]]; then
    tr -d '\r' < "$tmp" | awk 'NF {print; found=1} !NF && found {print ""}' | sed -e :a -e '/^\\n*$/{$d;N;ba' -e '}' | tr '\n' ' ' | sed 's/  */ /g'
  fi
  rm -f "$tmp"
}

cmd="${1:-help}"
case "$cmd" in
  help|-h|--help)
    usage
    ;;
  daily|d)
    [[ -d "$VAULT" ]] || die "vault not found: $VAULT"
    [[ -f "$TEMPLATE" ]] || die "template not found: $TEMPLATE"
    mkdir -p "$DAILY_DIR"
    date_str="$(date +%F)"
    daily_file="$DAILY_DIR/$date_str.md"
    if [[ ! -f "$daily_file" ]]; then
      render_template "$TEMPLATE" "" "$date_str" > "$daily_file"
    fi
    exec "$EDITOR_CMD" "$daily_file"
    ;;
  post|p)
    [[ -d "$PUBLIC_DIR" ]] || die "public dir not found: $PUBLIC_DIR"
    ensure_cmd rg
    ensure_cmd fzf
    selection="$(rg --files -g '*.md' "$PUBLIC_DIR" | fzf --prompt="obs> " || true)"
    [[ -n "$selection" ]] || exit 0
    exec "$EDITOR_CMD" "$selection"
    ;;
  memos|m)
    [[ -d "$VAULT" ]] || die "vault not found: $VAULT"
    [[ -f "$TEMPLATE" ]] || die "template not found: $TEMPLATE"
    mkdir -p "$DAILY_DIR"
    date_str="$(date +%F)"
    daily_file="$DAILY_DIR/$date_str.md"
    if [[ ! -f "$daily_file" ]]; then
      render_template "$TEMPLATE" "" "$date_str" > "$daily_file"
    fi
    shift || true
    if [[ $# -gt 0 ]]; then
      text="$*"
    else
      text="$(capture_memo_text)"
    fi
    append_memo "$daily_file" "${text:-}"
    ;;
  draft)
    [[ -d "$VAULT" ]] || die "vault not found: $VAULT"
    mkdir -p "${OBS_DRAFT_DIR:-$DRAFT_DIR}"
    shift || true
    title="${*:-}"
    if [[ -z "$title" ]]; then
      read -r -p "Title: " title
    fi
    [[ -n "$title" ]] || die "title is required"
    date_str="$(date +%F)"
    slug="$(slugify "$title")"
    draft_file="${OBS_DRAFT_DIR:-$DRAFT_DIR}/${date_str}-${slug}.md"
    [[ ! -f "$draft_file" ]] || die "draft already exists: $draft_file"
    if [[ -f "${OBS_DRAFT_TEMPLATE:-$DRAFT_TEMPLATE}" ]]; then
      render_template "${OBS_DRAFT_TEMPLATE:-$DRAFT_TEMPLATE}" "$title" "$date_str" > "$draft_file"
    else
      render_draft_frontmatter "$title" "$date_str" > "$draft_file"
    fi
    exec "$EDITOR_CMD" "$draft_file"
    ;;
  *)
    die "unknown command: $cmd"
    ;;
esac
