#!/usr/bin/env bash
set -euo pipefail

VAULT="${OBS_VAULT:-$HOME/src/github/k4h4shi/k4h4shi.com/vault}"
EDITOR_CMD="${OBS_EDITOR:-vim}"

detect_daily_dir() {
  if [[ -d "$VAULT/10_daily" ]]; then
    printf '%s\n' "$VAULT/10_daily"
    return
  fi
  if [[ -d "$VAULT/10_private/02_daily" ]]; then
    printf '%s\n' "$VAULT/10_private/02_daily"
    return
  fi
  printf '%s\n' "$VAULT/10_daily"
}

DAILY_DIR="${OBS_DAILY_DIR:-$(detect_daily_dir)}"
DAILY_TEMPLATE="${OBS_DAILY_TEMPLATE:-$VAULT/90_templates/Daily Template.md}"

POST_DIR="${OBS_POST_DIR:-$VAULT/70_garden/thoughts}"
NOTE_DIR="${OBS_NOTE_DIR:-$VAULT/20_notes}"

POST_TEMPLATE="${OBS_POST_TEMPLATE:-$VAULT/90_templates/Thought Template.md}"
NOTE_TEMPLATE="${OBS_NOTE_TEMPLATE:-$VAULT/90_templates/Note Template.md}"

usage() {
  cat <<'USAGE'
Usage:
  obs daily         # open today's daily note (create if missing)
  obs task [text]   # append a checkbox task under "ログ" in today's daily note
  obs thino [text]  # append thino-style line to today's daily note
  obs post [title]  # create a post note and link it under "ポスト"
  obs note [title]  # create a note and link it under "ノート"
  obs d|t|task|todo|td|p|n  # aliases
  obs help
Environment:
  OBS_VAULT
  OBS_EDITOR
  OBS_DAILY_DIR
  OBS_DAILY_TEMPLATE
  OBS_POST_DIR
  OBS_NOTE_DIR
  OBS_POST_TEMPLATE
  OBS_NOTE_TEMPLATE
USAGE
}

die() {
  echo "obs: $*" >&2
  exit 1
}

render_template() {
  local template="$1"
  local title="${2:-}"
  local date_str="${3:-}"
  python3 - "$template" "$title" "$date_str" <<'PY'
import re
import sys
from pathlib import Path

template = Path(sys.argv[1])
title = sys.argv[2]
date_str = sys.argv[3]

in_block = False
out_lines = []

for line in template.read_text(encoding="utf-8").splitlines(True):
    if not in_block and line.lstrip().startswith("<%*"):
        in_block = True
        if "%>" in line:
            in_block = False
        continue
    if in_block:
        if "%>" in line:
            in_block = False
        continue
    if title:
        line = line.replace('<% tp.file.title %>', title)
    if date_str:
        line = line.replace('<% tp.date.now("YYYY-MM-DD") %>', date_str)
        line = line.replace("<% tp.date.now('YYYY-MM-DD') %>", date_str)
    line = re.sub(r"<%.*?%>", "", line)
    out_lines.append(line)

sys.stdout.write("".join(out_lines))
PY
}

slugify() {
  local title="$1"
  python3 - "$title" <<'PY'
import re
import sys

title = sys.argv[1].strip().lower()
title = re.sub(r"[^a-z0-9]+", "-", title)
title = re.sub(r"-{2,}", "-", title).strip("-")
print(title or "untitled")
PY
}

ensure_daily_file() {
  local date_str="${1:-$(date +%F)}"
  [[ -d "$VAULT" ]] || die "vault not found: $VAULT"
  mkdir -p "$DAILY_DIR"

  local daily_file="$DAILY_DIR/$date_str.md"
  if [[ ! -f "$daily_file" ]]; then
    if [[ -f "$DAILY_TEMPLATE" ]]; then
      render_template "$DAILY_TEMPLATE" "" "$date_str" > "$daily_file"
    else
      cat > "$daily_file" <<EOF_DAILY
---
kind: daily
created: $date_str
tags:
  - dailynotes
---
## ログ

## ノート

## ポスト

## つぶやき
EOF_DAILY
    fi
  fi
  printf '%s\n' "$daily_file"
}

append_daily_link() {
  local daily_file="$1"
  local kind="$2"
  local note_file="$3"
  local display_title="$4"
  python3 - "$VAULT" "$daily_file" "$kind" "$note_file" "$display_title" <<'PY'
import sys
from pathlib import Path

vault = Path(sys.argv[1]).resolve()
daily_path = Path(sys.argv[2]).resolve()
kind = sys.argv[3].strip()
note_path = Path(sys.argv[4]).resolve()
display_title = sys.argv[5].strip()

text = daily_path.read_text(encoding="utf-8")
rel = note_path.relative_to(vault).as_posix()
link_target = rel[:-3] if rel.endswith(".md") else rel
if not display_title:
    display_title = note_path.stem

if kind == "note":
    section_title = "ノート"
elif kind == "post":
    section_title = "ポスト"
else:
    section_title = "Links"

line = f"- [[{link_target}|{display_title}]]"
lines = text.splitlines()
heading = f"## {section_title}"

heading_idx = None
for idx, raw in enumerate(lines):
    if raw.strip() == heading:
        heading_idx = idx
        break

if heading_idx is None:
    if lines and lines[-1].strip():
        lines.append("")
    lines.append(heading)
    lines.append(line)
else:
    next_idx = len(lines)
    for idx in range(heading_idx + 1, len(lines)):
        if lines[idx].startswith("## "):
            next_idx = idx
            break

    body = lines[heading_idx + 1 : next_idx]
    if any(f"[[{link_target}" in row for row in body):
        sys.exit(0)

    while body and not body[-1].strip():
        body.pop()
    body.append(line)
    if next_idx < len(lines):
        body.append("")

    lines = lines[: heading_idx + 1] + body + lines[next_idx:]

output = "\n".join(lines)
if output and not output.endswith("\n"):
    output += "\n"
daily_path.write_text(output, encoding="utf-8")
PY
}

create_note_from_template() {
  local kind="$1"
  local target_dir="$2"
  local template="$3"
  local prompt="$4"
  shift 4 || true

  local title="${*:-}"
  if [[ -z "$title" ]]; then
    read -r -p "$prompt: " title
  fi
  [[ -n "$title" ]] || die "title is required"

  local date_str slug note_file
  date_str="$(date +%F)"
  slug="$(slugify "$title")"

  mkdir -p "$target_dir"
  if [[ "$kind" == "note" || "$kind" == "post" ]]; then
    note_file="$target_dir/${slug}.md"
  else
    note_file="$target_dir/${date_str}-${slug}.md"
  fi
  if [[ -f "$note_file" ]]; then
    if [[ "$kind" == "note" || "$kind" == "post" ]]; then
      note_file="$target_dir/${slug}-$(date +%H%M%S).md"
    else
      note_file="$target_dir/${date_str}-$(date +%H%M%S)-${slug}.md"
    fi
  fi

  if [[ -f "$template" ]]; then
    render_template "$template" "$title" "$date_str" > "$note_file"
  else
    cat > "$note_file" <<EOF_NOTE
---
kind: $kind
created: $date_str
modified: $date_str
draft: true
tags: []
---

EOF_NOTE
  fi

  "$EDITOR_CMD" "$note_file"

  local daily_file
  daily_file="$(ensure_daily_file)"
  append_daily_link "$daily_file" "$kind" "$note_file" "$title"

  printf '%s\n' "$note_file"
}

capture_thino_text() {
  local tmp
  tmp="$(mktemp "${TMPDIR:-/tmp}/obs-thino.XXXXXX")"
  "$EDITOR_CMD" "$tmp"
  if [[ -s "$tmp" ]]; then
    tr -d '\r' < "$tmp" | awk 'NF {print; found=1} !NF && found {print ""}' | sed -e :a -e '/^\\n*$/{$d;N;ba' -e '}' | tr '\n' ' ' | sed 's/  */ /g'
  fi
  rm -f "$tmp"
}

append_thino_line() {
  local daily_file="$1"
  local text="$2"
  local time_str
  time_str="$(date +%H:%M)"
  python3 - "$daily_file" "$time_str" "$text" <<'PY'
import sys
from pathlib import Path

path = Path(sys.argv[1])
time_str = sys.argv[2]
text = sys.argv[3].strip()

if not text:
    sys.exit(0)

entry = f"- {time_str} {text}"

lines = path.read_text(encoding="utf-8").splitlines(True)
if lines and not lines[-1].endswith("\n"):
    lines[-1] += "\n"
lines.append(f"{entry}\n")
path.write_text("".join(lines), encoding="utf-8")
PY
}

append_task_line() {
  local daily_file="$1"
  local text="$2"
  python3 - "$daily_file" "$text" <<'PY'
import sys
from pathlib import Path

path = Path(sys.argv[1])
text = sys.argv[2].strip()

if not text:
    sys.exit(0)

entry = f"- [ ] {text}"
heading = "## ログ"
legacy_headings = {"## タスク", "## デイリーログ"}

lines = path.read_text(encoding="utf-8").splitlines()
heading_idx = None
for idx, raw in enumerate(lines):
    if raw.strip() == heading:
        heading_idx = idx
        break

if heading_idx is None:
    for idx, raw in enumerate(lines):
        if raw.strip() in legacy_headings:
            lines[idx] = heading
            heading_idx = idx
            break

if heading_idx is None:
    if lines and lines[-1].strip():
        lines.append("")
    lines.append(heading)
    lines.append("")
    lines.append(entry)
else:
    next_idx = len(lines)
    for idx in range(heading_idx + 1, len(lines)):
        if lines[idx].startswith("## "):
            next_idx = idx
            break

    body = lines[heading_idx + 1 : next_idx]
    while body and not body[-1].strip():
        body.pop()

    if not body:
        body = ["", entry]
    else:
        body.append(entry)

    if next_idx < len(lines):
        body.append("")

    lines = lines[: heading_idx + 1] + body + lines[next_idx:]

output = "\n".join(lines)
if output and not output.endswith("\n"):
    output += "\n"
path.write_text(output, encoding="utf-8")
PY
}

cmd="${1:-help}"
case "$cmd" in
  help|-h|--help)
    usage
    ;;
  daily|d)
    daily_file="$(ensure_daily_file)"
    exec "$EDITOR_CMD" "$daily_file"
    ;;
  thino|t)
    shift || true
    daily_file="$(ensure_daily_file)"
    if [[ $# -gt 0 ]]; then
      text="$*"
    else
      text="$(capture_thino_text)"
    fi
    append_thino_line "$daily_file" "${text:-}"
    ;;
  task|todo|td)
    shift || true
    daily_file="$(ensure_daily_file)"
    if [[ $# -gt 0 ]]; then
      text="$*"
    else
      read -r -p "Task: " text
    fi
    [[ -n "${text// }" ]] || die "task text is required"
    append_task_line "$daily_file" "$text"
    ;;
  post|p)
    shift || true
    create_note_from_template "post" "$POST_DIR" "$POST_TEMPLATE" "Post title" "$@"
    ;;
  note|n)
    shift || true
    create_note_from_template "note" "$NOTE_DIR" "$NOTE_TEMPLATE" "Note title" "$@"
    ;;
  *)
    die "unknown command: $cmd"
    ;;
esac
