description = "【詳細版】セッション分析＆設定改善提案。Usage: /session-retrospective [SESSION_ID]"
prompt = """
# Session Retrospective（詳細版）

特定の Claude Code セッションを分析し、設定改善を提案するコマンド。

> **Note**: 軽量版は `/retro` を使用してください。詳細な分析が必要な場合のみこちらを使用。

## 参考ドキュメント

改善提案を行う際は、以下の公式ドキュメントを参照:
- Memory: https://code.claude.com/docs/en/memory
- Skills: https://code.claude.com/docs/en/skills
- Custom Slash Commands: https://code.claude.com/docs/en/slash-commands#custom-slash-commands
- Sub-agents: https://code.claude.com/docs/en/sub-agents
- Hooks: https://code.claude.com/docs/en/hooks-guide

## 設定ファイルの種類

| 種類 | 場所 | 用途 |
|:-----|:----|:----|
| Memory | `CLAUDE.md`, `.claude/CLAUDE.md` | プロジェクト知識、コーディング規約 |
| Rules | `.claude/rules/*.md` | パス指定可能なモジュラールール |
| Skills | `.claude/skills/<name>/SKILL.md` | スラッシュコマンド、自動実行ワークフロー |
| Agents | `.claude/agents/<name>.md` | 特化型サブエージェント |
| Hooks | `settings.json` の `hooks` | ライフサイクルフック |
| Permissions | `settings.json` の `permissions.allow` | ツール許可ルール |

## 実行手順

### Step 1: 対象セッションを特定

**引数**: `{{args}}` にセッション ID が渡される（例: `/session-retrospective abc-123-def`）

- `{{args}}` が空なら **最新セッション** を自動選択
- `{{args}}` があれば **該当セッション** を検索

> Gemini CLI では、プロンプト中の `!{...}` がローカルで実行され、その出力がこのプロンプトに注入されます。
> ここでは `~/.claude/projects` と `~/.claude/debug` を直接読んで分析対象のログを注入します。

### Step 2: セッションログを読み込む

以下はローカルから注入したセッションログです（この内容を根拠に分析してください）:

!{python3 - {{args}} <<'PY'
import glob
import os
import sys

sid = sys.argv[1].strip() if len(sys.argv) > 1 else ""
projects_dir = os.path.expanduser("~/.claude/projects")
debug_dir = os.path.expanduser("~/.claude/debug")

session_file = ""
if sid:
    matches = glob.glob(os.path.join(projects_dir, "**", f"{sid}.jsonl"), recursive=True)
    session_file = matches[0] if matches else ""
else:
    matches = glob.glob(os.path.join(projects_dir, "*", "*.jsonl"))
    matches.sort(key=lambda p: os.path.getmtime(p), reverse=True)
    session_file = matches[0] if matches else ""

print("SESSION_FILE:", session_file)
if not session_file:
    print("ERROR: session file not found")
    raise SystemExit(0)

session_id = os.path.splitext(os.path.basename(session_file))[0]
print("SESSION_ID:", session_id)
print("")
print("---- SESSION_JSONL_BEGIN ----")
with open(session_file, "r", encoding="utf-8", errors="ignore") as f:
    print(f.read())
print("---- SESSION_JSONL_END ----")

debug_file = os.path.join(debug_dir, f"{session_id}.txt")
print("")
print("---- DEBUG_LOG_BEGIN ----")
if os.path.exists(debug_file):
    with open(debug_file, "r", encoding="utf-8", errors="ignore") as f:
        print(f.read())
else:
    print("(debug log not found)")
print("---- DEBUG_LOG_END ----")
PY}

### Step 3: 分析と改善提案

**1. セッションの概要**
- ユーザーが何を達成しようとしていたか
- 実際に何が行われたか
- 成功/失敗/中断したタスク

**2. Permissions の改善**
- デバッグログから `Permission suggestions for` を検出
- どのコマンドで許可待ちが発生したか
- **提案**: `settings.json` の `permissions.allow` に追加すべきルール
  ```json
  { "permissions": { "allow": ["Bash(npm test:*)"] } }
  ```

**3. Memory / Rules の改善**
- ユーザーが繰り返し説明したプロジェクト知識
- Claude が AskUserQuestion で確認した内容
- **提案**: `CLAUDE.md` または `.claude/rules/*.md` に追記すべき内容
  ```markdown
  # .claude/rules/testing.md
  ---
  paths: ["src/**/*.test.ts"]
  ---
  - テストは Jest を使用
  - モックは __mocks__ ディレクトリに配置
  ```

**4. Skills の改善**
- 繰り返し実行されたワークフロー
- 手動で毎回指示していた一連の操作
- **提案**: `.claude/skills/<name>/SKILL.md` として定義
  ```yaml
  ---
  name: deploy-preview
  description: Preview 環境にデプロイする
  disable-model-invocation: true
  allowed-tools: Bash(npm:*), Bash(gh:*)
  ---
  1. npm run build
  2. npm run deploy:preview
  3. gh pr comment で URL を共有
  ```

**5. Agents の改善**
- 特定タスクへの繰り返しの Task 委譲
- 同じツール制限/プロンプトパターン
- **提案**: `.claude/agents/<name>.md` として定義
  ```yaml
  ---
  name: test-runner
  description: テストを実行し、失敗を分析する
  tools: Read, Bash, Grep
  model: haiku
  ---
  テストを実行し、失敗があれば原因を分析してください。
  ```

**6. Hooks の改善**
- 毎回手動で行っていた前処理/後処理
- ファイル編集後のフォーマット、コミット前のチェック等
- **提案**: `settings.json` の `hooks` に追加
  ```json
  {
    "hooks": {
      "PostToolUse": [{
        "matcher": "Edit|Write",
        "hooks": [{ "type": "command", "command": "prettier --write ..." }]
      }]
    }
  }
  ```

### Step 4: レポートを作成・保存

このコマンドは **標準出力に Markdown レポートとして出力**してください（ファイル保存は呼び出し側でリダイレクトして行う想定）。

```markdown
# Session Retrospective: <SESSION_ID>

**Date**: YYYY-MM-DD HH:mm
**Project**: `/path/to/project`

## Session Summary

[このセッションで何が行われたかの概要]

## What Went Well

- [うまくいったこと]

## Suggested Improvements

### 1. Permissions (`settings.json`)

```json
{
  "permissions": {
    "allow": [
      "Bash(npm test:*)",
      "Bash(gh pr:*)"
    ]
  }
}
```

**理由**: [許可待ちが N 回発生]

### 2. Memory (`CLAUDE.md` or `.claude/rules/`)

```markdown
# 追記すべき内容
```

**理由**: [この知識を N 回説明した]

### 3. Skills (`.claude/skills/<name>/SKILL.md`)

```yaml
---
name: suggested-skill
description: ...
---
```

**理由**: [このワークフローを N 回実行した]

### 4. Agents (`.claude/agents/<name>.md`)

```yaml
---
name: suggested-agent
description: ...
tools: Read, Grep
---
```

**理由**: [この委譲パターンが N 回発生]

### 5. Hooks (`settings.json`)

```json
{
  "hooks": { ... }
}
```

**理由**: [この後処理を毎回手動で行った]

## Action Items

- [ ] 具体的なアクション1
- [ ] 具体的なアクション2
```

### Step 5: ユーザーに報告

1. レポートのパスを表示
2. 主要な改善提案を簡潔に説明
3. 優先度の高いアクションを提示

## 注意事項

- 分析結果はあくまで提案であり、ユーザーの判断で適用
- 機密情報が含まれる可能性があるため、レポートの共有には注意
- 設定ファイルの直接編集は行わない（提案のみ）
"""
